# Firebase Structure Documentation

## Overview
This document describes the Firebase Firestore database structure for the AuraPet application. All user-specific data is organized under the User-Module collection using the authenticated user's ID.

## Database Structure

### User-Module Collection
Path: `/User-Module/{userId}`

This is the main collection where each document represents a user (identified by Firebase Auth UID).

#### User Document Fields
- `username`: String - The user's display name
- `email`: String - User's email address
- `avatar`: String - Path to the user's selected avatar (e.g., 'assets/penguin.png' or 'assets/owl.png')
- `companion`: String - The selected companion type ('Penguin' or 'Owl')
- `createdAt`: Timestamp - Account creation date

#### Subcollections

##### 1. ChatHistory
Path: `/User-Module/{userId}/ChatHistory/{sessionId}`

Stores all chat conversations with the AI companion.

**Document Fields:**
- `title`: String - Auto-generated title from first user message (max 50 chars)
- `messages`: Array - List of message objects
  - `text`: String - Message content
  - `isUser`: Boolean - true if sent by user, false if from AI
  - `timestamp`: String (ISO 8601) - Message timestamp
- `createdAt`: Timestamp - Session creation time
- `updatedAt`: Timestamp - Last message time

**Usage:** Automatically saved when user exits chat session or receives AI response.

##### 2. DailyLetters
Path: `/User-Module/{userId}/DailyLetters/{dateKey}`

Stores daily letters generated by the AI companion.

**Document Fields:**
- `content`: String - The letter content generated by Gemini AI
- `petType`: String - The companion that wrote the letter (e.g., 'Poco (Penguin)' or 'Sage (Owl)')
- `isRead`: Boolean - Whether the user has read the letter
- `createdAt`: Timestamp - Letter generation time

**Date Key Format:** `YYYY-MM-DD` (e.g., '2025-12-24')

**Usage:** One letter per day, generated when user clicks the mail icon. Marked as read when opened.

##### 3. Feedback
Path: `/User-Module/{userId}/Feedback/{feedbackId}`

Stores user feedback submissions.

**Document Fields:**
- `rating`: Number - User rating (1-5 stars)
- `comment`: String - User's feedback text
- `submittedAt`: Timestamp - Submission time

**Usage:** Collected when users submit feedback through the rating page.

##### 4. mood_logs
Path: `/User-Module/{userId}/mood_logs/{dateKey}`

Stores daily mood entries.

**Document Fields:**
- `mood`: String - Selected mood (e.g., 'Happy', 'Sad', 'Angry', 'Stressed', 'Tired')
- `note`: String - Optional user note about their mood
- `timestamp`: Timestamp - Entry creation time

**Date Key Format:** `YYYY-MM-DD` (e.g., '2025-12-24')

**Usage:** One entry per day, created when user logs their mood. Used for mood tracking and analytics.

## Future Collections (To Be Implemented)

### Feedback-Module
Path: `/Feedback-Module/{userId}`

**Purpose:** Aggregate user feedback for analysis.

**Implementation Note:** Currently using subcollection under User-Module. Can be migrated to top-level collection for easier querying across all users.

### Sleep-Module
Path: `/Sleep-Module/{userId}`

**Purpose:** Store user's sleep tracking data, sleep story preferences, and listening history.

**Recommended Fields:**
- `sleepGoal`: Number - Target sleep hours
- `sleepSchedule`: Map - Bedtime and wake time preferences
- Subcollection: `sleep_logs` - Daily sleep records
- Subcollection: `story_history` - Played sleep stories

### Drawings Collection
Path: `/Drawings/{userId}`

**Purpose:** Store user's artwork from creative activities.

**Recommended Fields:**
- `imageUrl`: String - Firebase Storage path to drawing image
- `createdAt`: Timestamp
- `activityType`: String - Type of drawing activity

### Meditations Bucket
Path: `/Meditations/{userId}`

**Purpose:** Store meditation session history and preferences.

**Recommended Fields:**
- Subcollection: `meditation_logs` - Completed sessions
  - `duration`: Number - Session length in minutes
  - `type`: String - Meditation type
  - `completedAt`: Timestamp

## Firebase Storage Structure

### Avatars
Path: `/avatars/{userId}/avatar.png`

Stores user-uploaded custom avatars (if custom avatar feature is implemented).

### Drawings
Path: `/drawings/{userId}/{drawingId}.png`

Stores user drawings from creative activities.

## Security Rules Recommendations

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User-Module and subcollections
    match /User-Module/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /ChatHistory/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      match /DailyLetters/{dateKey} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      match /Feedback/{feedbackId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      match /mood_logs/{dateKey} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
```

## API Keys and Environment Variables

### .env File
Location: Root directory of project

**Required Variables:**
- `GEMINI_API_KEY`: Google Gemini API key for AI companion and letter generation

**Setup:**
1. Create `.env` file in project root
2. Add: `GEMINI_API_KEY=your_api_key_here`
3. Ensure `.env` is listed in `pubspec.yaml` assets section
4. Restart the app after adding the key

## Notes

- All timestamps use Firestore Timestamp type for consistency
- User IDs are obtained from `FirebaseAuth.instance.currentUser?.uid`
- Date keys use format `YYYY-MM-DD` for consistent sorting
- Subcollections allow for efficient querying of user-specific data
- Collection names use kebab-case (with hyphens) or snake_case
